<!doctype html>
<head>
	<title>Threebox fixed zoom</title>
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
	<script src="../dist/threebox.js" type="text/javascript"></script>
	<link href="../dist/threebox.css" rel="stylesheet" />
	<script src="config.js"></script>
	<style>
		body, html {
			width: 100%;
			height: 100%;
			margin: 0;
		}

		#map {
			width: 100%;
			height: 100%;
		}
	</style>

</head>
<body>
	<div id='map' class='map'></div>

	<script type="module">
		if (!config) console.error("Config not set! Make a copy of 'config_template.js', add in your access token, and save the file as 'config.js'.");

		mapboxgl.accessToken = config.accessToken;
		let mapConfig = {
			MAD: {
				origin: [2.272043600678484,48.8700817475247, 0], 
				destination: [2.289113514125347,48.879606150739804, 500], 
				center: [2.272043600678484,48.8700817475247, 0], 
				zoom: 18, 
				pitch: 80, 
				bearing: 35, 
				scale: 1, 
				timezone: 'Europe/Madrid'
			},
			names: {
				customLayer: "custom-layer"
			}
		}

		let map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/kikistef/cl32rlf6c002314qqinxrgo3x',
			center: mapConfig.MAD.center,
			zoom: mapConfig.MAD.zoom,
			pitch: mapConfig.MAD.pitch,
			antialias: true,
			bearing: mapConfig.MAD.bearing
		});

		// we can add Threebox to mapbox to add built-in mouseover/mouseout and click behaviors
		window.tb = new Threebox(
			map,
			map.getCanvas().getContext('webgl'),
			{
				realSunlight: true,
				enableSelectingObjects: true, //change this to false to disable 3D objects selection
				enableTooltips: true, // change this to false to disable default tooltips on fill-extrusion and 3D models
			}
		);
		tb.altitudeStep = 1;
		tb.setSunlight(new Date(2021, 5, 18, 15));


		import { GUI } from 'https://threejs.org/examples/jsm/libs/lil-gui.module.min.js';
		//import Stats from 'https://threejs.org/examples/jsm/libs/stats.module.js';

		let /*stats, */gui;
		function animate() {
			requestAnimationFrame(animate);
			//stats.update();
		}

		let plane;
		let api = {
			fixedZoom: true,
			pan: true,
			maxZoom: 10
		};

		map.on('style.load', function () {
			init();

			map.addLayer({
				id: 'custom_layer',
				type: 'custom',
				renderingMode: '3d',
				onAdd: function (map, mbxContext) {

					// Creative Commons License attribution: Plane model by https://sketchfab.com/ideehochzwei
					// from  https://sketchfab.com/3d-models/plane-aa001f5a88f64b16b98356c042f2d5f3
					  let geometry = new THREE.CylinderGeometry( 5, 5, 0.1, 32 );
					var material = new THREE.MeshBasicMaterial( {color: 0xff0000, opacity:0.8});
					let cube = new THREE.Mesh(geometry, material);
					var sphereAxis = new THREE.AxesHelper(0.6);
					let options = {
						obj: './models/plane/plane.fbx',
						type: 'fbx',
						scale: mapConfig.MAD.scale,
						rotation: { x: 90, y: 0, z: 0 },
						//position: { x:0, y:50, z:0 },
						anchor: 'center',
						bbox: false
					}

					//if (api.fixedZoom) options.fixedZoom = api.maxZoom;

					tb.loadObj(options, function (model) {
						plane = model.setCoords(mapConfig.MAD.origin);
						plane.setRotation({ x: 0, y: 0, z: 30 });
						//plane.setTranslate({ x: 10, y: 10, z: 30 });
						plane.addTooltip("You can set the fixed scale of this plane", true);
						plane.addEventListener('ObjectChanged', onObjectChanged, false);
						plane.castShadow = true;
						tb.add(plane);
						plane.add(sphereAxis);
						//tb.add(cube);

						fly(flightPlan);
						
//						setTimeout(() => {
//							let opt = {
//								coords: mapConfig.MAD.destination, duration: 20000
//							};
//							plane.set(opt)
//						}, 3000);

					})
				},

				render: function (gl, matrix) {
					tb.update();
				}
			});
			 map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
			 });
			map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 0 });
			        map.addLayer({
            'id': 'sky',
            'type': 'sky',
            'paint': {
                'sky-type': 'atmosphere',
				'sky-atmosphere-color': '#5eadf3',
                'sky-atmosphere-sun': [0.0, 45.0],
                'sky-atmosphere-sun-intensity': 15,
				'sky-atmosphere-halo-color': '#fff',
				//'sky-gradient': '#53b9fe',
            }
        });
			/////////////////////////////////////////////////////
			 map.addSource('trace', {
            type: 'geojson',
            data: {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': flightPlan.geometry.coordinates
                }
            }
        });
        map.addLayer({
            type: 'line',
            source: 'trace',
            id: 'line',
            paint: {
                'line-color': 'rgba(72, 130,197, 1)',
                'line-width': 8
            },
            layout: {
                'line-cap': 'round',
                'line-join': 'round'
            }
        });
////////////////////////////////////////
		});

		function init() {
			// stats
			//stats = new Stats();
			//map.getContainer().appendChild(stats.dom);
			animate();
			// gui
			gui = new GUI();
			// this will define if there's a fixed zoom level for the model
			gui.add(api, 'fixedZoom').name('fixed zoom').onChange(changeScale);
			gui.add(api, 'pan').name('pan').onChange(changeScale);
			gui.add(api, 'maxZoom', 0, map.transform.maxZoom).step(0.5).onChange(changeScale);
		}

		function onObjectChanged(e) {
			let model = e.detail.object; //here's the object already modified
			if (api.pan) map.panTo(model.coordinates);
		}

		function changeScale() {
			plane.fixedZoom = (api.fixedZoom ? api.maxZoom : null);
			plane.setObjectScale(map.transform.scale);
			tb.map.repaint = true;
		}

		let line;

		function fly(data) {
			// extract path geometry from callback geojson, and set duration of travel
			var options = {
				path: data.geometry.coordinates,
				duration: 120000
			}

			// start the truck animation with above options, and remove the line when animation ends
			plane.followPath(
				options,
				function () {
					tb.remove(line);
				}
			);

			// set up geometry for a line to be added to map, lofting it up a bit for *style*
			let lineGeometry = options.path;

			// create and add line object
			line = tb.line({
				geometry: lineGeometry,
				width: 10,
				color: '#0f54a5'
			})

			//tb.add(line, mapConfig.names.customLayer);

		}

		let flightPlan = {
			"geometry": {
				"coordinates": [
					 [
            2.272045277059118,
            48.87008086538819
          ],
          [
            2.2723390837199986,
            48.870328193801285
          ],
          [
            2.2725329780951142,
            48.870497011556864
          ],
          [
            2.27287590270862,
            48.87082902182347
          ],
          [
            2.2729814518243074,
            48.87093697154847
          ],
          [
            2.2734355938155204,
            48.871435505497324
          ],
          [
            2.273915216792375,
            48.871962702845224
          ],
          [
            2.2747872909530997,
            48.87302369651075
          ],
          [
            2.2760660550557077,
            48.87449681127996
          ],
          [
            2.2763037763070315,
            48.874767740374644
          ],
          [
            2.2764714248478413,
            48.87493590917639
          ],
          [
            2.2770397388376296,
            48.875244956809915
          ],
          [
            2.2772660554619506,
            48.87536378473103
          ],
          [
            2.277481472992804,
            48.87544811627508
          ],
          [
            2.278052953770384,
            48.875732670445615
          ],
          [
            2.2782382802688517,
            48.8758236166327
          ],
          [
            2.2784980380674824,
            48.87596307448198
          ],
          [
            2.2786317726422567,
            48.87604316713078
          ],
          [
            2.278843291278463,
            48.87618235562477
          ],
          [
            2.278977025853237,
            48.87627148870376
          ],
          [
            2.279102043248713,
            48.876369882893826
          ],
          [
            2.2794913197867572,
            48.87672566871642
          ],
          [
            2.279857126995921,
            48.877080569995364
          ],
          [
            2.280206322320737,
            48.877123981558675
          ],
          [
            2.2808344673831016,
            48.87730498669942
          ],
          [
            2.2812539082951844,
            48.87737769727506
          ],
          [
            2.281659430009313,
            48.87713423495099
          ],
          [
            2.281913823389914,
            48.877056383536654
          ],
          [
            2.282177604502067,
            48.87699881833962
          ],
          [
            2.282479439454619,
            48.87696881605484
          ],
          [
            2.2827839566161856,
            48.87698423753466
          ],
          [
            2.283356781117618,
            48.877091154151444
          ],
          [
            2.283605063566938,
            48.87715912422519
          ],
          [
            2.283751757349819,
            48.87720923349046
          ],
          [
            2.284155775560066,
            48.877164416295166
          ],
          [
            2.2871925443178043,
            48.87622966818572
          ],
          [
            2.28804574086098,
            48.877826210041654
          ],
          [
            2.2881217686926902,
            48.87782204961151
          ],
          [
            2.2881977965244005,
            48.877832001180636
          ],
          [
            2.2882671188335735,
            48.87786223873613
          ],
          [
            2.2883176656796422,
            48.87790835224883
          ],
          [
            2.2883423164148553,
            48.87797323723616
          ],
          [
            2.288321369596815,
            48.87803988613171
          ],
          [
            2.288261530748059,
            48.87808889503525
          ],
          [
            2.2881762109136616,
            48.87811938200375
          ],
          [
            2.2880592154251644,
            48.87812126227186
          ],
          [
            2.287571116903564,
            48.879076036590604
          ],
          [
            2.289113514125347,
            48.879606150739804
          ]],
				"type": "LineString"
			},
			"type": "Feature",
			"properties": {}
		}
		
		var deltaPitch = 0.5;
		var deltaBearing = 5;
document.body.onkeydown = function(ev){
		switch (ev.which) {
//touche "<- " pour passer au point de vue precedent
	case 37:
			console.log(" fleche <- ");
				map.setBearing = map.getBearing() - deltaBearing;
			/*map.jumpTo({
			bearing: map.getBearing() - deltaBearing,
			easing: easing
			});*/
	break;

//touche " -> " pour passer au point de vue suivant				
	case 39:
		console.log(" fleche -> ");
			map.setBearing = map.getBearing() + deltaBearing;
			/*map.jumpTo({
			bearing: map.getBearing() + deltaBearing,
			easing: easing
			});*/
	break;

//touche ----------[ - ]----------  pour ralentir l'ego car	
	case 109:
		
		if (cameraAltitude >= 45){
			console.log(" signe - : " + cameraAltitude);
			cameraAltitude -= 0.8;		
		}
	break;
			
//touche ----------[ + ]----------  pour ralentir l'ego car	
	case 107:
		console.log(" signe + : " + cameraAltitude);
		cameraAltitude += 0.8;	
	break;
	//touche ----------[ T ]----------  pour le tilt		
	case 84:
		
		console.log("pitch + : " + map.getPitch() + deltaPitch);
			map.easeTo({
			pitch: map.getPitch() + deltaPitch,
			easing: easing
			});
	break;

//touche ----------[ G ]----------  pour le tilt		
	case 71:
		console.log("pitch - : " + (map.getPitch() - deltaPitch));
			map.easeTo({
			pitch: map.getPitch() - deltaPitch,
			easing: easing
			});
	break;
//touche ----------[ R ]----------  pour la rotation		
	case 82:
		
		console.log("bearing + : " + map.getBearing() + deltaBearing);
			map.easeTo({
			bearing: map.getBearing() + deltaBearing,
			easing: easing
			});
	break;

//touche ----------[ F ]----------  pour la rotation		
	case 70:
		console.log("bearing - : " + (map.getBearing() - deltaBearing));
			map.easeTo({
			bearing: map.getBearing() - deltaBearing,
			easing: easing
			});
	break;
		
//touche ----------[ i ]----------  pour ralentir l'ego car	
	case 73:
		//isPaused = !isPaused; // flips the pause state
		
		//console.log(" lettre i ");
	break;
		}
		

	};
function easing(t) {
	return t * (10 - t);
}
	</script>
</body>
